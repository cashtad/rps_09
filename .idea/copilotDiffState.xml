<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/client/src/main/java/com/rps/MainApp.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/client/src/main/java/com/rps/MainApp.java" />
              <option name="originalContent" value="package com.rps;&#10;&#10;import com.rps.network.EventBus;&#10;import com.rps.network.NetworkManager;&#10;import com.rps.network.ProtocolHandler;&#10;import com.rps.network.ServerEvent;&#10;import javafx.application.Application;&#10;import javafx.application.Platform;&#10;import javafx.geometry.Insets;&#10;import javafx.geometry.Pos;&#10;import javafx.scene.Scene;&#10;import javafx.scene.control.*;&#10;import javafx.scene.layout.BorderPane;&#10;import javafx.scene.layout.HBox;&#10;import javafx.scene.layout.VBox;&#10;import javafx.stage.Stage;&#10;import javafx.animation.Timeline;&#10;import javafx.animation.KeyFrame;&#10;import javafx.util.Duration;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;public class MainApp extends Application {&#10;&#10;    private NetworkManager networkManager;&#10;    private ProtocolHandler protocolHandler;&#10;    private EventBus eventBus;&#10;&#10;    private Stage primaryStage;&#10;    private Button connectButton;&#10;    private Label statusLabel;&#10;    private Button listRoomsButton;&#10;    private TextField nameField;&#10;    private PlayerProfile playerProfile;&#10;&#10;    private Label opponentLabel;&#10;    private Label opponentStatusLabel;&#10;    private Label playerStatusLabel;&#10;    private Button readyButton;&#10;&#10;    // Game scene elements&#10;    private Label playerScoreLabel;&#10;    private Label opponentScoreLabel;&#10;    private Label timerLabel;&#10;    private Label resultLabel;&#10;    private Button rockButton;&#10;    private Button paperButton;&#10;    private Button scissorsButton;&#10;    private Timeline gameTimer;&#10;    private int remainingTime;&#10;&#10;    @Override&#10;    public void start(Stage stage) {&#10;        this.primaryStage = stage;&#10;&#10;        // Инициализируем компоненты&#10;        networkManager = new NetworkManager();&#10;        eventBus = new EventBus();&#10;        protocolHandler = new ProtocolHandler(networkManager, eventBus);&#10;&#10;        // Настраиваем подписки на события ПЕРЕД показом UI&#10;        setupEventHandlers();&#10;&#10;        // ==================== UI SETUP ====================&#10;        VBox loginLayout = new VBox(10);&#10;        loginLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        nameField = new TextField();&#10;        nameField.setPromptText(&quot;Enter your name&quot;);&#10;&#10;        connectButton = new Button(&quot;Connect&quot;);&#10;&#10;        statusLabel = new Label();&#10;        statusLabel.setStyle(&quot;-fx-text-fill: green; -fx-font-weight: bold;&quot;);&#10;&#10;        listRoomsButton = new Button(&quot;List of rooms&quot;);&#10;        listRoomsButton.setDisable(true);&#10;&#10;        loginLayout.getChildren().addAll(nameField, connectButton, statusLabel, listRoomsButton);&#10;&#10;        Scene loginScene = new Scene(loginLayout, 300, 200);&#10;        stage.setTitle(&quot;RPS Client&quot;);&#10;        stage.setScene(loginScene);&#10;        stage.show();&#10;&#10;        // ==================== BUTTON ACTIONS ====================&#10;        connectButton.setOnAction(e -&gt; {&#10;            connectToServer();&#10;        });&#10;        listRoomsButton.setOnAction(e -&gt; protocolHandler.requestRooms());&#10;    }&#10;&#10;    private void setupEventHandlers() {&#10;        // ========== Логирование всех событий (опционально) ==========&#10;        eventBus.subscribeAll(event -&gt; {&#10;//            System.out.println(&quot; Event: &quot; + event.getCommand());&#10;        });&#10;&#10;        // ========== WELCOME - успешное подключение ==========&#10;        eventBus.subscribe(&quot;WELCOME&quot;, event -&gt; {&#10;            String token = event.getPart(1);&#10;            playerProfile = new PlayerProfile(nameField.getText());&#10;            playerProfile.setToken(token);&#10;            playerProfile.setStatus(PlayerProfile.PlayerStatus.CONNECTED);&#10;&#10;            statusLabel.setText(&quot;Connected as &quot; + token);&#10;            connectButton.setDisable(true);&#10;            listRoomsButton.setDisable(false);&#10;        });&#10;&#10;        // ========== ROOMS_LOADED - список комнат загружен ==========&#10;        eventBus.subscribe(&quot;ROOMS_LOADED&quot;, event -&gt; {&#10;            String roomsData = event.getPart(1);&#10;            List&lt;String&gt; roomList = roomsData != null &amp;&amp; !roomsData.isEmpty()&#10;                    ? List.of(roomsData.split(&quot;\\|&quot;))&#10;                    : new ArrayList&lt;&gt;();&#10;            showRoomsScene(roomList);&#10;        });&#10;&#10;        // ========== ROOM_JOINED - успешное подключение к комнате ==========&#10;        eventBus.subscribe(&quot;ROOM_JOINED&quot;, event -&gt; {&#10;            String roomId = event.getPart(1);&#10;            playerProfile.setStatus(PlayerProfile.PlayerStatus.IN_LOBBY);&#10;            showLobbyScene(roomId, playerProfile.getName());&#10;        });&#10;&#10;        // ========== Обработка ошибок ==========&#10;        eventBus.subscribe(&quot;ERR&quot;, event -&gt; {&#10;            String errorCode = event.getPart(1);&#10;            String errorMsg = event.getPartsCount() &gt; 2 ? event.getPart(2) : &quot;Unknown error&quot;;&#10;            showAlert(&quot;Error&quot;, &quot;Error &quot; + errorCode + &quot;: &quot; + errorMsg);&#10;        });&#10;&#10;        // ========== События лобби (глобальные подписки) ==========&#10;&#10;        // Информация о противнике&#10;        eventBus.subscribe(&quot;OPPONENT_INFO&quot;, this::handleOpponentInfo);&#10;&#10;        // Присоединился игрок&#10;        eventBus.subscribe(&quot;PLAYER_JOINED&quot;, this::handlePlayerJoined);&#10;&#10;        // Игрок готов&#10;        eventBus.subscribe(&quot;PLAYER_READY&quot;, this::handlePlayerReady);&#10;&#10;        // Игрок не готов&#10;        eventBus.subscribe(&quot;PLAYER_UNREADY&quot;, this::handlePlayerUnready);&#10;&#10;        // Игрок покинул комнату&#10;        eventBus.subscribe(&quot;PLAYER_LEFT&quot;, this::handlePlayerLeft);&#10;&#10;        // Начало игры&#10;        eventBus.subscribe(&quot;GAME_START&quot;, event -&gt; {&#10;            Platform.runLater(this::showGameScene);&#10;        });&#10;&#10;        // ========== События игры ==========&#10;&#10;        // Начало раунда&#10;        eventBus.subscribe(&quot;ROUND_START&quot;, this::handleRoundStart);&#10;&#10;        // Результат раунда&#10;        eventBus.subscribe(&quot;ROUND_RESULT&quot;, this::handleRoundResult);&#10;&#10;        // Конец игры&#10;        eventBus.subscribe(&quot;GAME_END&quot;, this::handleGameEnd);&#10;&#10;        // Ход принят&#10;        eventBus.subscribe(&quot;MOVE_ACCEPTED&quot;, event -&gt; {&#10;            Platform.runLater(() -&gt; {&#10;                disableMoveButtons();&#10;                resultLabel.setText(&quot;Waiting for opponent...&quot;);&#10;            });&#10;        });&#10;    }&#10;&#10;    // ========== Обработчики событий лобби ==========&#10;&#10;    private void handleOpponentInfo(ServerEvent event) {&#10;        String opponentName = event.getPart(1);&#10;        if (opponentLabel == null) return;&#10;&#10;        if (&quot;NONE&quot;.equals(opponentName)) {&#10;            opponentLabel.setText(&quot;Enemy: -&quot;);&#10;            opponentStatusLabel.setText(&quot;Status: -&quot;);&#10;        } else {&#10;            String status = event.getPart(2);&#10;            opponentLabel.setText(&quot;Enemy: &quot; + opponentName);&#10;            opponentStatusLabel.setText(&quot;Status: &quot; + (&quot;READY&quot;.equals(status) ? &quot;Ready&quot; : &quot;Not ready&quot;));&#10;        }&#10;    }&#10;&#10;    private void handlePlayerJoined(ServerEvent event) {&#10;        String opponentName = event.getPart(1);&#10;        if (opponentLabel != null &amp;&amp; !opponentName.equals(playerProfile.getName())) {&#10;            opponentLabel.setText(&quot;Enemy: &quot; + opponentName);&#10;            opponentStatusLabel.setText(&quot;Status: Not ready&quot;);&#10;        }&#10;    }&#10;&#10;    private void handlePlayerReady(ServerEvent event) {&#10;        String readyPlayer = event.getPart(1);&#10;        if (readyPlayer.equals(playerProfile.getName())) {&#10;            if (playerStatusLabel != null) playerStatusLabel.setText(&quot;Status: Ready&quot;);&#10;            if (readyButton != null) readyButton.setDisable(true);&#10;        } else {&#10;            if (opponentStatusLabel != null) opponentStatusLabel.setText(&quot;Status: Ready&quot;);&#10;        }&#10;    }&#10;&#10;    private void handlePlayerUnready(ServerEvent event) {&#10;        String unreadyPlayer = event.getPart(1);&#10;        if (unreadyPlayer.equals(playerProfile.getName())) {&#10;            if (playerStatusLabel != null) playerStatusLabel.setText(&quot;Status: Not ready&quot;);&#10;            if (readyButton != null) readyButton.setDisable(false);&#10;        } else {&#10;            if (opponentStatusLabel != null) opponentStatusLabel.setText(&quot;Status: Not ready&quot;);&#10;        }&#10;    }&#10;&#10;    private void handlePlayerLeft(ServerEvent event) {&#10;        if (opponentLabel != null) {&#10;            opponentLabel.setText(&quot;Enemy: -&quot;);&#10;            opponentStatusLabel.setText(&quot;Status: -&quot;);&#10;        }&#10;    }&#10;&#10;    private void connectToServer() {&#10;        String nickname = nameField.getText().trim();&#10;        if (nickname.isEmpty()) {&#10;            showAlert(&quot;Error&quot;, &quot;Enter your name!&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            networkManager.connect(&quot;0.0.0.0&quot;, 2500);&#10;            protocolHandler.sendHello(nickname);&#10;        } catch (Exception ex) {&#10;            showAlert(&quot;Connection error&quot;, ex.getMessage());&#10;            ex.printStackTrace();&#10;        }&#10;    }&#10;&#10;    private void showRoomsScene(List&lt;String&gt; roomsRaw) {&#10;        VBox roomsLayout = new VBox(10);&#10;        roomsLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        Label title = new Label(&quot;List of rooms:&quot;);&#10;&#10;        // Преобразуем строки в объекты GameRoom&#10;        List&lt;GameRoom&gt; roomItems = new ArrayList&lt;&gt;();&#10;        for (String raw : roomsRaw) {&#10;            String[] parts = raw.split(&quot; &quot;);&#10;            if (parts.length &gt;= 4) {&#10;                roomItems.add(new GameRoom(&#10;                        Integer.parseInt(parts[0]),&#10;                        parts[1],&#10;                        Integer.parseInt(parts[2].split(&quot;/&quot;)[0]),&#10;                        parts[3]&#10;                ));&#10;            }&#10;        }&#10;&#10;        ListView&lt;GameRoom&gt; listView = new ListView&lt;&gt;();&#10;        listView.getItems().addAll(roomItems);&#10;&#10;        listView.setCellFactory(lv -&gt; new ListCell&lt;&gt;() {&#10;            private final Button joinButton = new Button(&quot;Join&quot;);&#10;            private final HBox hbox = new HBox(10);&#10;&#10;            {&#10;                joinButton.setOnAction(e -&gt; {&#10;                    GameRoom item = getItem();&#10;                    if (item != null) {&#10;                        protocolHandler.joinRoom(String.valueOf(item.getId()));&#10;                    }&#10;                });&#10;            }&#10;&#10;            @Override&#10;            protected void updateItem(GameRoom item, boolean empty) {&#10;                super.updateItem(item, empty);&#10;                if (empty || item == null) {&#10;                    setText(null);&#10;                    setGraphic(null);&#10;                } else {&#10;                    Label nameLabel = new Label(item.toString());&#10;                    hbox.getChildren().setAll(nameLabel, joinButton);&#10;                    setGraphic(hbox);&#10;                }&#10;            }&#10;        });&#10;&#10;        Button createRoomButton = new Button(&quot;Create room&quot;);&#10;        createRoomButton.setOnAction(e -&gt; showCreateRoomDialog());&#10;&#10;        Button refreshButton = new Button(&quot;Refresh&quot;);&#10;        refreshButton.setOnAction(e -&gt; protocolHandler.requestRooms());&#10;&#10;        HBox buttons = new HBox(10, createRoomButton, refreshButton);&#10;        roomsLayout.getChildren().addAll(title, listView, buttons);&#10;&#10;        Scene roomsScene = new Scene(roomsLayout, 400, 400);&#10;        primaryStage.setScene(roomsScene);&#10;    }&#10;&#10;    private void showCreateRoomDialog() {&#10;        Stage dialog = new Stage();&#10;        dialog.initOwner(primaryStage);&#10;        dialog.setTitle(&quot;Create room&quot;);&#10;&#10;        VBox dialogLayout = new VBox(10);&#10;        dialogLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        Label prompt = new Label(&quot;Enter room name:&quot;);&#10;        TextField roomNameField = new TextField();&#10;&#10;        Button cancelButton = new Button(&quot;Cancel&quot;);&#10;        Button confirmButton = new Button(&quot;Create&quot;);&#10;&#10;        cancelButton.setOnAction(e -&gt; dialog.close());&#10;        confirmButton.setOnAction(e -&gt; {&#10;            String roomName = roomNameField.getText().trim();&#10;            if (!roomName.isEmpty()) {&#10;                protocolHandler.createRoom(roomName);&#10;                dialog.close();&#10;            }&#10;        });&#10;&#10;        HBox buttons = new HBox(10, cancelButton, confirmButton);&#10;        dialogLayout.getChildren().addAll(prompt, roomNameField, buttons);&#10;&#10;        Scene dialogScene = new Scene(dialogLayout, 250, 150);&#10;        dialog.setScene(dialogScene);&#10;        dialog.show();&#10;    }&#10;&#10;    private void showLobbyScene(String roomId, String playerName) {&#10;        BorderPane lobbyLayout = new BorderPane();&#10;        lobbyLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        // ======= Кнопка назад =======&#10;        Button backButton = new Button(&quot;Back&quot;);&#10;        backButton.setOnAction(e -&gt; {&#10;            protocolHandler.leaveRoom();&#10;            protocolHandler.requestRooms();&#10;        });&#10;        lobbyLayout.setTop(backButton);&#10;        BorderPane.setMargin(backButton, new Insets(0, 0, 10, 0));&#10;&#10;        // ======= Слева: твой игрок =======&#10;        VBox playerBox = new VBox(10);&#10;        playerBox.setStyle(&quot;-fx-border-color: black; -fx-padding: 10;&quot;);&#10;        Label playerLabel = new Label(&quot;You: &quot; + playerName);&#10;        playerStatusLabel = new Label(&quot;Status: Not ready&quot;);&#10;        readyButton = new Button(&quot;Ready&quot;);&#10;        playerBox.getChildren().addAll(playerLabel, playerStatusLabel, readyButton);&#10;&#10;        // ======= Справа: противник =======&#10;        VBox opponentBox = new VBox(10);&#10;        opponentBox.setStyle(&quot;-fx-border-color: black; -fx-padding: 10;&quot;);&#10;        opponentLabel = new Label(&quot;Enemy: -&quot;);&#10;        opponentStatusLabel = new Label(&quot;Status: -&quot;);&#10;        opponentBox.getChildren().addAll(opponentLabel, opponentStatusLabel);&#10;&#10;        lobbyLayout.setLeft(playerBox);&#10;        lobbyLayout.setRight(opponentBox);&#10;&#10;        Scene lobbyScene = new Scene(lobbyLayout, 500, 300);&#10;        primaryStage.setScene(lobbyScene);&#10;&#10;        // ======= Кнопка готов =======&#10;        readyButton.setOnAction(e -&gt; {&#10;            protocolHandler.markReady();&#10;        });&#10;&#10;        // ======= Запрашиваем информацию о противнике =======&#10;        protocolHandler.requestOpponentInfo();&#10;    }&#10;&#10;    // ========== Game scene handlers ==========&#10;&#10;    private void handleRoundStart(ServerEvent event) {&#10;        int roundNumber = Integer.parseInt(event.getPart(1));&#10;        Platform.runLater(() -&gt; {&#10;            enableMoveButtons();&#10;            resultLabel.setText(&quot;Round &quot; + roundNumber + &quot; - Make your move!&quot;);&#10;            startTimer(30);&#10;        });&#10;    }&#10;&#10;    private void handleRoundResult(ServerEvent event) {&#10;        String winner = event.getPart(1);&#10;        char moveP1 = event.getPart(2).charAt(0);&#10;        char moveP2 = event.getPart(3).charAt(0);&#10;        int scoreP1 = Integer.parseInt(event.getPart(4));&#10;        int scoreP2 = Integer.parseInt(event.getPart(5));&#10;&#10;        Platform.runLater(() -&gt; {&#10;            stopTimer();&#10;            updateScores(scoreP1, scoreP2);&#10;&#10;            String moveStr1 = getMoveString(moveP1);&#10;            String moveStr2 = getMoveString(moveP2);&#10;&#10;            String resultText;&#10;            if (&quot;DRAW&quot;.equals(winner)) {&#10;                resultText = &quot;Draw! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            } else if (&quot;TIMEOUT&quot;.equals(winner)) {&#10;                resultText = &quot;Timeout! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            } else if (winner.equals(playerProfile.getName())) {&#10;                resultText = &quot;You win! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            } else {&#10;                resultText = &quot;You lose! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            }&#10;&#10;            resultLabel.setText(resultText);&#10;        });&#10;    }&#10;&#10;    private void handleGameEnd(ServerEvent event) {&#10;        String winner = event.getPart(1);&#10;        Platform.runLater(() -&gt; {&#10;            stopTimer();&#10;            String message = winner.equals(playerProfile.getName())&#10;                    ? &quot;Congratulations! You won the game!&quot;&#10;                    : &quot;Game Over! &quot; + winner + &quot; won!&quot;;&#10;&#10;            showAlert(&quot;Game Finished&quot;, message);&#10;            protocolHandler.requestRooms();&#10;        });&#10;    }&#10;&#10;    private void showGameScene() {&#10;        BorderPane gameLayout = new BorderPane();&#10;        gameLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        // Top: Score display&#10;        HBox scoreBox = new HBox(50);&#10;        scoreBox.setAlignment(Pos.CENTER);&#10;        scoreBox.setStyle(&quot;-fx-padding: 10;&quot;);&#10;&#10;        playerScoreLabel = new Label(&quot;You: 0&quot;);&#10;        playerScoreLabel.setStyle(&quot;-fx-font-size: 20; -fx-font-weight: bold;&quot;);&#10;&#10;        opponentScoreLabel = new Label(&quot;Opponent: 0&quot;);&#10;        opponentScoreLabel.setStyle(&quot;-fx-font-size: 20; -fx-font-weight: bold;&quot;);&#10;&#10;        scoreBox.getChildren().addAll(playerScoreLabel, opponentScoreLabel);&#10;&#10;        // Timer&#10;        timerLabel = new Label(&quot;Time: 30&quot;);&#10;        timerLabel.setStyle(&quot;-fx-font-size: 18; -fx-padding: 10;&quot;);&#10;        timerLabel.setAlignment(Pos.CENTER);&#10;&#10;        VBox topBox = new VBox(10, scoreBox, timerLabel);&#10;        topBox.setAlignment(Pos.CENTER);&#10;        gameLayout.setTop(topBox);&#10;&#10;        // Center: Result display&#10;        resultLabel = new Label(&quot;Waiting for round to start...&quot;);&#10;        resultLabel.setStyle(&quot;-fx-font-size: 16; -fx-padding: 20;&quot;);&#10;        resultLabel.setAlignment(Pos.CENTER);&#10;        resultLabel.setWrapText(true);&#10;        gameLayout.setCenter(resultLabel);&#10;&#10;        // Bottom: Move buttons&#10;        HBox buttonBox = new HBox(20);&#10;        buttonBox.setAlignment(Pos.CENTER);&#10;        buttonBox.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        rockButton = new Button(&quot;Rock&quot;);&#10;        rockButton.setStyle(&quot;-fx-font-size: 16; -fx-min-width: 100; -fx-min-height: 50;&quot;);&#10;        rockButton.setOnAction(e -&gt; makeMove(&quot;R&quot;));&#10;&#10;        paperButton = new Button(&quot;Paper&quot;);&#10;        paperButton.setStyle(&quot;-fx-font-size: 16; -fx-min-width: 100; -fx-min-height: 50;&quot;);&#10;        paperButton.setOnAction(e -&gt; makeMove(&quot;P&quot;));&#10;&#10;        scissorsButton = new Button(&quot;Scissors&quot;);&#10;        scissorsButton.setStyle(&quot;-fx-font-size: 16; -fx-min-width: 100; -fx-min-height: 50;&quot;);&#10;        scissorsButton.setOnAction(e -&gt; makeMove(&quot;S&quot;));&#10;&#10;        buttonBox.getChildren().addAll(rockButton, paperButton, scissorsButton);&#10;        gameLayout.setBottom(buttonBox);&#10;&#10;        Scene gameScene = new Scene(gameLayout, 600, 400);&#10;        primaryStage.setScene(gameScene);&#10;&#10;        disableMoveButtons();&#10;    }&#10;&#10;    private void makeMove(String move) {&#10;        protocolHandler.sendMove(move);&#10;        disableMoveButtons();&#10;    }&#10;&#10;    private void enableMoveButtons() {&#10;        rockButton.setDisable(false);&#10;        paperButton.setDisable(false);&#10;        scissorsButton.setDisable(false);&#10;    }&#10;&#10;    private void disableMoveButtons() {&#10;        rockButton.setDisable(true);&#10;        paperButton.setDisable(true);&#10;        scissorsButton.setDisable(true);&#10;    }&#10;&#10;    private void updateScores(int playerScore, int opponentScore) {&#10;        playerScoreLabel.setText(&quot;You: &quot; + playerScore);&#10;        opponentScoreLabel.setText(&quot;Opponent: &quot; + opponentScore);&#10;    }&#10;&#10;    private void startTimer(int seconds) {&#10;        stopTimer();&#10;        remainingTime = seconds;&#10;        timerLabel.setText(&quot;Time: &quot; + remainingTime);&#10;&#10;        gameTimer = new Timeline(new KeyFrame(Duration.seconds(1), e -&gt; {&#10;            remainingTime--;&#10;            timerLabel.setText(&quot;Time: &quot; + remainingTime);&#10;&#10;            if (remainingTime &lt;= 0) {&#10;                stopTimer();&#10;            }&#10;        }));&#10;        gameTimer.setCycleCount(Timeline.INDEFINITE);&#10;        gameTimer.play();&#10;    }&#10;&#10;    private void stopTimer() {&#10;        if (gameTimer != null) {&#10;            gameTimer.stop();&#10;        }&#10;    }&#10;&#10;    private String getMoveString(char move) {&#10;        switch (move) {&#10;            case 'R': return &quot;Rock&quot;;&#10;            case 'P': return &quot;Paper&quot;;&#10;            case 'S': return &quot;Scissors&quot;;&#10;            case 'X': return &quot;None&quot;;&#10;            default: return &quot;Unknown&quot;;&#10;        }&#10;    }&#10;&#10;    private void showAlert(String title, String message) {&#10;        Alert alert = new Alert(Alert.AlertType.INFORMATION);&#10;        alert.setTitle(title);&#10;        alert.setHeaderText(null);&#10;        alert.setContentText(message);&#10;        alert.showAndWait();&#10;    }&#10;&#10;    @Override&#10;    public void stop() throws Exception {&#10;        super.stop();&#10;        stopTimer();&#10;        eventBus.clear();&#10;        networkManager.disconnect();&#10;    }&#10;&#10;    public static void main(String[] args) {&#10;        launch(args);&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.rps;&#10;&#10;import com.rps.network.EventBus;&#10;import com.rps.network.NetworkManager;&#10;import com.rps.network.ProtocolHandler;&#10;import com.rps.network.ServerEvent;&#10;import javafx.application.Application;&#10;import javafx.application.Platform;&#10;import javafx.geometry.Insets;&#10;import javafx.geometry.Pos;&#10;import javafx.scene.Scene;&#10;import javafx.scene.control.*;&#10;import javafx.scene.layout.BorderPane;&#10;import javafx.scene.layout.HBox;&#10;import javafx.scene.layout.VBox;&#10;import javafx.stage.Stage;&#10;import javafx.animation.Timeline;&#10;import javafx.animation.KeyFrame;&#10;import javafx.util.Duration;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;public class MainApp extends Application {&#10;&#10;    private NetworkManager networkManager;&#10;    private ProtocolHandler protocolHandler;&#10;    private EventBus eventBus;&#10;&#10;    private Stage primaryStage;&#10;    private Button connectButton;&#10;    private Label statusLabel;&#10;    private Button listRoomsButton;&#10;    private TextField nameField;&#10;    private PlayerProfile playerProfile;&#10;&#10;    private Label opponentLabel;&#10;    private Label opponentStatusLabel;&#10;    private Label playerStatusLabel;&#10;    private Button readyButton;&#10;&#10;    // Game scene elements&#10;    private Label playerScoreLabel;&#10;    private Label opponentScoreLabel;&#10;    private Label timerLabel;&#10;    private Label resultLabel;&#10;    private Button rockButton;&#10;    private Button paperButton;&#10;    private Button scissorsButton;&#10;    private Timeline gameTimer;&#10;    private int remainingTime;&#10;&#10;    @Override&#10;    public void start(Stage stage) {&#10;        this.primaryStage = stage;&#10;&#10;        // Инициализируем компоненты&#10;        networkManager = new NetworkManager();&#10;        eventBus = new EventBus();&#10;        protocolHandler = new ProtocolHandler(networkManager, eventBus);&#10;&#10;        // Настраиваем подписки на события ПЕРЕД показом UI&#10;        setupEventHandlers();&#10;&#10;        // ==================== UI SETUP ====================&#10;        VBox loginLayout = new VBox(10);&#10;        loginLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        nameField = new TextField();&#10;        nameField.setPromptText(&quot;Enter your name&quot;);&#10;&#10;        connectButton = new Button(&quot;Connect&quot;);&#10;&#10;        statusLabel = new Label();&#10;        statusLabel.setStyle(&quot;-fx-text-fill: green; -fx-font-weight: bold;&quot;);&#10;&#10;        listRoomsButton = new Button(&quot;List of rooms&quot;);&#10;        listRoomsButton.setDisable(true);&#10;&#10;        loginLayout.getChildren().addAll(nameField, connectButton, statusLabel, listRoomsButton);&#10;&#10;        Scene loginScene = new Scene(loginLayout, 300, 200);&#10;        stage.setTitle(&quot;RPS Client&quot;);&#10;        stage.setScene(loginScene);&#10;        stage.show();&#10;&#10;        // ==================== BUTTON ACTIONS ====================&#10;        connectButton.setOnAction(e -&gt; {&#10;            connectToServer();&#10;        });&#10;        listRoomsButton.setOnAction(e -&gt; protocolHandler.requestRooms());&#10;    }&#10;&#10;    private void setupEventHandlers() {&#10;        // ========== Логирование всех событий (опционально) ==========&#10;        eventBus.subscribeAll(event -&gt; {&#10;//            System.out.println(&quot; Event: &quot; + event.getCommand());&#10;        });&#10;&#10;        // ========== WELCOME - успешное подключение ==========&#10;        eventBus.subscribe(&quot;WELCOME&quot;, event -&gt; {&#10;            String token = event.getPart(1);&#10;            playerProfile = new PlayerProfile(nameField.getText());&#10;            playerProfile.setToken(token);&#10;            playerProfile.setStatus(PlayerProfile.PlayerStatus.CONNECTED);&#10;&#10;            statusLabel.setText(&quot;Connected as &quot; + token);&#10;            connectButton.setDisable(true);&#10;            listRoomsButton.setDisable(false);&#10;        });&#10;&#10;        // ========== ROOMS_LOADED - список комнат загружен ==========&#10;        eventBus.subscribe(&quot;ROOMS_LOADED&quot;, event -&gt; {&#10;            String roomsData = event.getPart(1);&#10;            List&lt;String&gt; roomList = roomsData != null &amp;&amp; !roomsData.isEmpty()&#10;                    ? List.of(roomsData.split(&quot;\\|&quot;))&#10;                    : new ArrayList&lt;&gt;();&#10;            showRoomsScene(roomList);&#10;        });&#10;&#10;        // ========== ROOM_JOINED - успешное подключение к комнате ==========&#10;        eventBus.subscribe(&quot;ROOM_JOINED&quot;, event -&gt; {&#10;            String roomId = event.getPart(1);&#10;            playerProfile.setStatus(PlayerProfile.PlayerStatus.IN_LOBBY);&#10;            showLobbyScene(roomId, playerProfile.getName());&#10;        });&#10;&#10;        // ========== Обработка ошибок ==========&#10;        eventBus.subscribe(&quot;ERR&quot;, event -&gt; {&#10;            String errorCode = event.getPart(1);&#10;            String errorMsg = event.getPartsCount() &gt; 2 ? event.getPart(2) : &quot;Unknown error&quot;;&#10;            showAlert(&quot;Error&quot;, &quot;Error &quot; + errorCode + &quot;: &quot; + errorMsg);&#10;        });&#10;&#10;        // ========== События лобби (глобальные подписки) ==========&#10;&#10;        // Информация о противнике&#10;        eventBus.subscribe(&quot;OPPONENT_INFO&quot;, this::handleOpponentInfo);&#10;&#10;        // Присоединился игрок&#10;        eventBus.subscribe(&quot;PLAYER_JOINED&quot;, this::handlePlayerJoined);&#10;&#10;        // Игрок готов&#10;        eventBus.subscribe(&quot;PLAYER_READY&quot;, this::handlePlayerReady);&#10;&#10;        // Игрок не готов&#10;        eventBus.subscribe(&quot;PLAYER_UNREADY&quot;, this::handlePlayerUnready);&#10;&#10;        // Игрок покинул комнату&#10;        eventBus.subscribe(&quot;PLAYER_LEFT&quot;, this::handlePlayerLeft);&#10;&#10;        // Начало игры&#10;        eventBus.subscribe(&quot;GAME_START&quot;, event -&gt; {&#10;            Platform.runLater(this::showGameScene);&#10;        });&#10;&#10;        // ========== События игры ==========&#10;&#10;        // Начало раунда&#10;        eventBus.subscribe(&quot;ROUND_START&quot;, this::handleRoundStart);&#10;&#10;        // Результат раунда&#10;        eventBus.subscribe(&quot;ROUND_RESULT&quot;, this::handleRoundResult);&#10;&#10;        // Конец игры&#10;        eventBus.subscribe(&quot;GAME_END&quot;, this::handleGameEnd);&#10;&#10;        // Ход принят&#10;        eventBus.subscribe(&quot;MOVE_ACCEPTED&quot;, event -&gt; {&#10;            Platform.runLater(() -&gt; {&#10;                disableMoveButtons();&#10;                resultLabel.setText(&quot;Waiting for opponent...&quot;);&#10;            });&#10;        });&#10;    }&#10;&#10;    // ========== Обработчики событий лобби ==========&#10;&#10;    private void handleOpponentInfo(ServerEvent event) {&#10;        String opponentName = event.getPart(1);&#10;        if (opponentLabel == null) return;&#10;&#10;        if (&quot;NONE&quot;.equals(opponentName)) {&#10;            opponentLabel.setText(&quot;Enemy: -&quot;);&#10;            opponentStatusLabel.setText(&quot;Status: -&quot;);&#10;        } else {&#10;            String status = event.getPart(2);&#10;            opponentLabel.setText(&quot;Enemy: &quot; + opponentName);&#10;            opponentStatusLabel.setText(&quot;Status: &quot; + (&quot;READY&quot;.equals(status) ? &quot;Ready&quot; : &quot;Not ready&quot;));&#10;        }&#10;    }&#10;&#10;    private void handlePlayerJoined(ServerEvent event) {&#10;        String opponentName = event.getPart(1);&#10;        if (opponentLabel != null &amp;&amp; !opponentName.equals(playerProfile.getName())) {&#10;            opponentLabel.setText(&quot;Enemy: &quot; + opponentName);&#10;            opponentStatusLabel.setText(&quot;Status: Not ready&quot;);&#10;        }&#10;    }&#10;&#10;    private void handlePlayerReady(ServerEvent event) {&#10;        String readyPlayer = event.getPart(1);&#10;        if (readyPlayer.equals(playerProfile.getName())) {&#10;            if (playerStatusLabel != null) playerStatusLabel.setText(&quot;Status: Ready&quot;);&#10;            if (readyButton != null) readyButton.setDisable(true);&#10;        } else {&#10;            if (opponentStatusLabel != null) opponentStatusLabel.setText(&quot;Status: Ready&quot;);&#10;        }&#10;    }&#10;&#10;    private void handlePlayerUnready(ServerEvent event) {&#10;        String unreadyPlayer = event.getPart(1);&#10;        if (unreadyPlayer.equals(playerProfile.getName())) {&#10;            if (playerStatusLabel != null) playerStatusLabel.setText(&quot;Status: Not ready&quot;);&#10;            if (readyButton != null) readyButton.setDisable(false);&#10;        } else {&#10;            if (opponentStatusLabel != null) opponentStatusLabel.setText(&quot;Status: Not ready&quot;);&#10;        }&#10;    }&#10;&#10;    private void handlePlayerLeft(ServerEvent event) {&#10;        if (opponentLabel != null) {&#10;            opponentLabel.setText(&quot;Enemy: -&quot;);&#10;            opponentStatusLabel.setText(&quot;Status: -&quot;);&#10;        }&#10;    }&#10;&#10;    private void connectToServer() {&#10;        String nickname = nameField.getText().trim();&#10;        if (nickname.isEmpty()) {&#10;            showAlert(&quot;Error&quot;, &quot;Enter your name!&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            networkManager.connect(&quot;0.0.0.0&quot;, 2500);&#10;            protocolHandler.sendHello(nickname);&#10;        } catch (Exception ex) {&#10;            showAlert(&quot;Connection error&quot;, ex.getMessage());&#10;            ex.printStackTrace();&#10;        }&#10;    }&#10;&#10;    private void showRoomsScene(List&lt;String&gt; roomsRaw) {&#10;        VBox roomsLayout = new VBox(10);&#10;        roomsLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        Label title = new Label(&quot;List of rooms:&quot;);&#10;&#10;        // Преобразуем строки в объекты GameRoom&#10;        List&lt;GameRoom&gt; roomItems = new ArrayList&lt;&gt;();&#10;        for (String raw : roomsRaw) {&#10;            String[] parts = raw.split(&quot; &quot;);&#10;            if (parts.length &gt;= 4) {&#10;                roomItems.add(new GameRoom(&#10;                        Integer.parseInt(parts[0]),&#10;                        parts[1],&#10;                        Integer.parseInt(parts[2].split(&quot;/&quot;)[0]),&#10;                        parts[3]&#10;                ));&#10;            }&#10;        }&#10;&#10;        ListView&lt;GameRoom&gt; listView = new ListView&lt;&gt;();&#10;        listView.getItems().addAll(roomItems);&#10;&#10;        listView.setCellFactory(lv -&gt; new ListCell&lt;&gt;() {&#10;            private final Button joinButton = new Button(&quot;Join&quot;);&#10;            private final HBox hbox = new HBox(10);&#10;&#10;            {&#10;                joinButton.setOnAction(e -&gt; {&#10;                    GameRoom item = getItem();&#10;                    if (item != null) {&#10;                        protocolHandler.joinRoom(String.valueOf(item.getId()));&#10;                    }&#10;                });&#10;            }&#10;&#10;            @Override&#10;            protected void updateItem(GameRoom item, boolean empty) {&#10;                super.updateItem(item, empty);&#10;                if (empty || item == null) {&#10;                    setText(null);&#10;                    setGraphic(null);&#10;                } else {&#10;                    Label nameLabel = new Label(item.toString());&#10;                    hbox.getChildren().setAll(nameLabel, joinButton);&#10;                    setGraphic(hbox);&#10;                }&#10;            }&#10;        });&#10;&#10;        Button createRoomButton = new Button(&quot;Create room&quot;);&#10;        createRoomButton.setOnAction(e -&gt; showCreateRoomDialog());&#10;&#10;        Button refreshButton = new Button(&quot;Refresh&quot;);&#10;        refreshButton.setOnAction(e -&gt; protocolHandler.requestRooms());&#10;&#10;        HBox buttons = new HBox(10, createRoomButton, refreshButton);&#10;        roomsLayout.getChildren().addAll(title, listView, buttons);&#10;&#10;        Scene roomsScene = new Scene(roomsLayout, 400, 400);&#10;        primaryStage.setScene(roomsScene);&#10;    }&#10;&#10;    private void showCreateRoomDialog() {&#10;        Stage dialog = new Stage();&#10;        dialog.initOwner(primaryStage);&#10;        dialog.setTitle(&quot;Create room&quot;);&#10;&#10;        VBox dialogLayout = new VBox(10);&#10;        dialogLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        Label prompt = new Label(&quot;Enter room name:&quot;);&#10;        TextField roomNameField = new TextField();&#10;&#10;        Button cancelButton = new Button(&quot;Cancel&quot;);&#10;        Button confirmButton = new Button(&quot;Create&quot;);&#10;&#10;        cancelButton.setOnAction(e -&gt; dialog.close());&#10;        confirmButton.setOnAction(e -&gt; {&#10;            String roomName = roomNameField.getText().trim();&#10;            if (!roomName.isEmpty()) {&#10;                protocolHandler.createRoom(roomName);&#10;                dialog.close();&#10;            }&#10;        });&#10;&#10;        HBox buttons = new HBox(10, cancelButton, confirmButton);&#10;        dialogLayout.getChildren().addAll(prompt, roomNameField, buttons);&#10;&#10;        Scene dialogScene = new Scene(dialogLayout, 250, 150);&#10;        dialog.setScene(dialogScene);&#10;        dialog.show();&#10;    }&#10;&#10;    private void showLobbyScene(String roomId, String playerName) {&#10;        BorderPane lobbyLayout = new BorderPane();&#10;        lobbyLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        // ======= Кнопка назад =======&#10;        Button backButton = new Button(&quot;Back&quot;);&#10;        backButton.setOnAction(e -&gt; {&#10;            protocolHandler.leaveRoom();&#10;            protocolHandler.requestRooms();&#10;        });&#10;        lobbyLayout.setTop(backButton);&#10;        BorderPane.setMargin(backButton, new Insets(0, 0, 10, 0));&#10;&#10;        // ======= Слева: твой игрок =======&#10;        VBox playerBox = new VBox(10);&#10;        playerBox.setStyle(&quot;-fx-border-color: black; -fx-padding: 10;&quot;);&#10;        Label playerLabel = new Label(&quot;You: &quot; + playerName);&#10;        playerStatusLabel = new Label(&quot;Status: Not ready&quot;);&#10;        readyButton = new Button(&quot;Ready&quot;);&#10;        playerBox.getChildren().addAll(playerLabel, playerStatusLabel, readyButton);&#10;&#10;        // ======= Справа: противник =======&#10;        VBox opponentBox = new VBox(10);&#10;        opponentBox.setStyle(&quot;-fx-border-color: black; -fx-padding: 10;&quot;);&#10;        opponentLabel = new Label(&quot;Enemy: -&quot;);&#10;        opponentStatusLabel = new Label(&quot;Status: -&quot;);&#10;        opponentBox.getChildren().addAll(opponentLabel, opponentStatusLabel);&#10;&#10;        lobbyLayout.setLeft(playerBox);&#10;        lobbyLayout.setRight(opponentBox);&#10;&#10;        Scene lobbyScene = new Scene(lobbyLayout, 500, 300);&#10;        primaryStage.setScene(lobbyScene);&#10;&#10;        // ======= Кнопка готов =======&#10;        readyButton.setOnAction(e -&gt; {&#10;            protocolHandler.markReady();&#10;        });&#10;&#10;        // ======= Запрашиваем информацию о противнике =======&#10;        protocolHandler.requestOpponentInfo();&#10;    }&#10;&#10;    // ========== Game scene handlers ==========&#10;&#10;    private void handleRoundStart(ServerEvent event) {&#10;        int roundNumber = Integer.parseInt(event.getPart(1));&#10;        Platform.runLater(() -&gt; {&#10;            enableMoveButtons();&#10;            resultLabel.setText(&quot;Round &quot; + roundNumber + &quot; - Make your move!&quot;);&#10;            startTimer(30);&#10;        });&#10;    }&#10;&#10;    private void handleRoundResult(ServerEvent event) {&#10;        String winner = event.getPart(1);&#10;        char moveP1 = event.getPart(2).charAt(0);&#10;        char moveP2 = event.getPart(3).charAt(0);&#10;        int scoreP1 = Integer.parseInt(event.getPart(4));&#10;        int scoreP2 = Integer.parseInt(event.getPart(5));&#10;&#10;        Platform.runLater(() -&gt; {&#10;            stopTimer();&#10;            updateScores(scoreP1, scoreP2);&#10;&#10;            String moveStr1 = getMoveString(moveP1);&#10;            String moveStr2 = getMoveString(moveP2);&#10;&#10;            String resultText;&#10;            if (&quot;DRAW&quot;.equals(winner)) {&#10;                resultText = &quot;Draw! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            } else if (&quot;TIMEOUT&quot;.equals(winner)) {&#10;                resultText = &quot;Timeout! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            } else if (winner.equals(playerProfile.getName())) {&#10;                resultText = &quot;You win! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            } else {&#10;                resultText = &quot;You lose! You: &quot; + moveStr1 + &quot; vs &quot; + moveStr2;&#10;            }&#10;&#10;            resultLabel.setText(resultText);&#10;        });&#10;    }&#10;&#10;    private void handleGameEnd(ServerEvent event) {&#10;        String winner = event.getPart(1);&#10;        Platform.runLater(() -&gt; {&#10;            stopTimer();&#10;            String message = winner.equals(playerProfile.getName())&#10;                    ? &quot;Congratulations! You won the game!&quot;&#10;                    : &quot;Game Over! &quot; + winner + &quot; won!&quot;;&#10;&#10;            showAlert(&quot;Game Finished&quot;, message);&#10;            protocolHandler.requestRooms();&#10;        });&#10;    }&#10;&#10;    private void showGameScene() {&#10;        BorderPane gameLayout = new BorderPane();&#10;        gameLayout.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        // Top: Score display&#10;        HBox scoreBox = new HBox(50);&#10;        scoreBox.setAlignment(Pos.CENTER);&#10;        scoreBox.setStyle(&quot;-fx-padding: 10;&quot;);&#10;&#10;        playerScoreLabel = new Label(&quot;You: 0&quot;);&#10;        playerScoreLabel.setStyle(&quot;-fx-font-size: 20; -fx-font-weight: bold;&quot;);&#10;&#10;        opponentScoreLabel = new Label(&quot;Opponent: 0&quot;);&#10;        opponentScoreLabel.setStyle(&quot;-fx-font-size: 20; -fx-font-weight: bold;&quot;);&#10;&#10;        scoreBox.getChildren().addAll(playerScoreLabel, opponentScoreLabel);&#10;&#10;        // Timer&#10;        timerLabel = new Label(&quot;Time: 30&quot;);&#10;        timerLabel.setStyle(&quot;-fx-font-size: 18; -fx-padding: 10;&quot;);&#10;        timerLabel.setAlignment(Pos.CENTER);&#10;&#10;        VBox topBox = new VBox(10, scoreBox, timerLabel);&#10;        topBox.setAlignment(Pos.CENTER);&#10;        gameLayout.setTop(topBox);&#10;&#10;        // Center: Result display&#10;        resultLabel = new Label(&quot;Waiting for round to start...&quot;);&#10;        resultLabel.setStyle(&quot;-fx-font-size: 16; -fx-padding: 20;&quot;);&#10;        resultLabel.setAlignment(Pos.CENTER);&#10;        resultLabel.setWrapText(true);&#10;        gameLayout.setCenter(resultLabel);&#10;&#10;        // Bottom: Move buttons&#10;        HBox buttonBox = new HBox(20);&#10;        buttonBox.setAlignment(Pos.CENTER);&#10;        buttonBox.setStyle(&quot;-fx-padding: 20;&quot;);&#10;&#10;        rockButton = new Button(&quot;Rock&quot;);&#10;        rockButton.setStyle(&quot;-fx-font-size: 16; -fx-min-width: 100; -fx-min-height: 50;&quot;);&#10;        rockButton.setOnAction(e -&gt; makeMove(&quot;R&quot;));&#10;&#10;        paperButton = new Button(&quot;Paper&quot;);&#10;        paperButton.setStyle(&quot;-fx-font-size: 16; -fx-min-width: 100; -fx-min-height: 50;&quot;);&#10;        paperButton.setOnAction(e -&gt; makeMove(&quot;P&quot;));&#10;&#10;        scissorsButton = new Button(&quot;Scissors&quot;);&#10;        scissorsButton.setStyle(&quot;-fx-font-size: 16; -fx-min-width: 100; -fx-min-height: 50;&quot;);&#10;        scissorsButton.setOnAction(e -&gt; makeMove(&quot;S&quot;));&#10;&#10;        buttonBox.getChildren().addAll(rockButton, paperButton, scissorsButton);&#10;        gameLayout.setBottom(buttonBox);&#10;&#10;        Scene gameScene = new Scene(gameLayout, 600, 400);&#10;        primaryStage.setScene(gameScene);&#10;&#10;        disableMoveButtons();&#10;    }&#10;&#10;    private void makeMove(String move) {&#10;        protocolHandler.sendMove(move);&#10;        disableMoveButtons();&#10;    }&#10;&#10;    private void enableMoveButtons() {&#10;        rockButton.setDisable(false);&#10;        paperButton.setDisable(false);&#10;        scissorsButton.setDisable(false);&#10;    }&#10;&#10;    private void disableMoveButtons() {&#10;        rockButton.setDisable(true);&#10;        paperButton.setDisable(true);&#10;        scissorsButton.setDisable(true);&#10;    }&#10;&#10;    private void updateScores(int playerScore, int opponentScore) {&#10;        playerScoreLabel.setText(&quot;You: &quot; + playerScore);&#10;        opponentScoreLabel.setText(&quot;Opponent: &quot; + opponentScore);&#10;    }&#10;&#10;    private void startTimer(int seconds) {&#10;        stopTimer();&#10;        remainingTime = seconds;&#10;        timerLabel.setText(&quot;Time: &quot; + remainingTime);&#10;&#10;        gameTimer = new Timeline(new KeyFrame(Duration.seconds(1), e -&gt; {&#10;            remainingTime--;&#10;            timerLabel.setText(&quot;Time: &quot; + remainingTime);&#10;&#10;            if (remainingTime &lt;= 0) {&#10;                stopTimer();&#10;            }&#10;        }));&#10;        gameTimer.setCycleCount(Timeline.INDEFINITE);&#10;        gameTimer.play();&#10;    }&#10;&#10;    private void stopTimer() {&#10;        if (gameTimer != null) {&#10;            gameTimer.stop();&#10;        }&#10;    }&#10;&#10;    private String getMoveString(char move) {&#10;        switch (move) {&#10;            case 'R': return &quot;Rock&quot;;&#10;            case 'P': return &quot;Paper&quot;;&#10;            case 'S': return &quot;Scissors&quot;;&#10;            case 'X': return &quot;None&quot;;&#10;            default: return &quot;Unknown&quot;;&#10;        }&#10;    }&#10;&#10;    private void showAlert(String title, String message) {&#10;        Alert alert = new Alert(Alert.AlertType.INFORMATION);&#10;        alert.setTitle(title);&#10;        alert.setHeaderText(null);&#10;        alert.setContentText(message);&#10;        alert.showAndWait();&#10;    }&#10;&#10;    @Override&#10;    public void stop() throws Exception {&#10;        super.stop();&#10;        stopTimer();&#10;        eventBus.clear();&#10;        networkManager.disconnect();&#10;    }&#10;&#10;    public static void main(String[] args) {&#10;        launch(args);&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/client/src/main/java/com/rps/network/ProtocolHandler.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/client/src/main/java/com/rps/network/ProtocolHandler.java" />
              <option name="originalContent" value="package com.rps.network;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;public class ProtocolHandler {&#10;    private final NetworkManager net;&#10;    private final EventBus eventBus;&#10;    private String token;&#10;&#10;    // Временные данные для сбора списка комнат&#10;    private final List&lt;String&gt; tempRooms = new ArrayList&lt;&gt;();&#10;    private int expectedRooms = 0;&#10;&#10;    public ProtocolHandler(NetworkManager net, EventBus eventBus) {&#10;        this.net = net;&#10;        this.eventBus = eventBus;&#10;        this.net.setOnMessageReceived(this::handleMessage);&#10;        setupInternalHandlers();&#10;    }&#10;&#10;    private void setupInternalHandlers() {&#10;        // Обработка ROOM_LIST - начало сбора комнат&#10;        eventBus.subscribe(&quot;ROOM_LIST&quot;, event -&gt; {&#10;            expectedRooms = Integer.parseInt(event.getPart(1));&#10;            tempRooms.clear();&#10;&#10;            // Если комнат 0, сразу публикуем событие с пустым списком&#10;            if (expectedRooms == 0) {&#10;                eventBus.publish(new ServerEvent(&quot;ROOMS_LOADED&quot;,&#10;                        new String[]{&quot;ROOMS_LOADED&quot;}, &quot;ROOMS_LOADED&quot;));&#10;            }&#10;        });&#10;&#10;        // Обработка ROOM - добавление комнаты в список&#10;        eventBus.subscribe(&quot;ROOM&quot;, event -&gt; {&#10;            tempRooms.add(event.getFullMessage().substring(5));&#10;&#10;            // Когда собрали все комнаты, публикуем событие&#10;            if (tempRooms.size() == expectedRooms) {&#10;                // Создаем специальное событие с полным списком комнат&#10;                String roomsData = String.join(&quot;|&quot;, tempRooms);&#10;                eventBus.publish(new ServerEvent(&quot;ROOMS_LOADED&quot;,&#10;                        new String[]{&quot;ROOMS_LOADED&quot;, roomsData}, roomsData));&#10;            }&#10;        });&#10;&#10;        // Обработка ROOM_CREATED - автоматический запрос списка комнат&#10;        eventBus.subscribe(&quot;ROOM_CREATED&quot;, event -&gt; {&#10;            requestRooms();&#10;        });&#10;    }&#10;&#10;    private void handleMessage(String msg) {&#10;        System.out.println(&quot;SERVER: &quot; + msg);&#10;&#10;        String[] parts = msg.split(&quot; &quot;, 2); // Разделяем только на команду и остальное&#10;        String command = parts[0];&#10;&#10;        // Парсим для детального доступа&#10;        String[] allParts = msg.split(&quot; &quot;);&#10;&#10;        // Создаем событие и публикуем в шину&#10;        ServerEvent event = new ServerEvent(command, allParts, msg);&#10;        eventBus.publish(event);&#10;&#10;        // Сохраняем токен при WELCOME&#10;        if (&quot;WELCOME&quot;.equals(command) &amp;&amp; allParts.length &gt; 1) {&#10;            token = allParts[1];&#10;        }&#10;    }&#10;&#10;    // =================== Client Commands ===================&#10;&#10;    public void sendHello(String nickname) {&#10;        net.send(&quot;HELLO &quot; + nickname);&#10;    }&#10;&#10;    public void requestRooms() {&#10;        net.send(&quot;LIST&quot;);&#10;    }&#10;&#10;    public void createRoom(String name) {&#10;        net.send(&quot;CREATE &quot; + name);&#10;    }&#10;&#10;    public void joinRoom(String id) {&#10;        net.send(&quot;JOIN &quot; + id);&#10;    }&#10;&#10;    public void markReady() {&#10;        net.send(&quot;READY&quot;);&#10;    }&#10;&#10;    public void sendMove(String move) {&#10;        net.send(&quot;MOVE &quot; + move);&#10;    }&#10;&#10;    public void leaveRoom() {&#10;        net.send(&quot;LEAVE&quot;);&#10;    }&#10;&#10;    public void requestOpponentInfo() {&#10;        net.send(&quot;GET_OPPONENT&quot;);&#10;    }&#10;&#10;    public String getToken() {&#10;        return token;&#10;    }&#10;&#10;    public EventBus getEventBus() {&#10;        return eventBus;&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.rps.network;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;public class ProtocolHandler {&#10;    private final NetworkManager net;&#10;    private final EventBus eventBus;&#10;    private String token;&#10;&#10;    // Временные данные для сбора списка комнат&#10;    private final List&lt;String&gt; tempRooms = new ArrayList&lt;&gt;();&#10;    private int expectedRooms = 0;&#10;&#10;    public ProtocolHandler(NetworkManager net, EventBus eventBus) {&#10;        this.net = net;&#10;        this.eventBus = eventBus;&#10;        this.net.setOnMessageReceived(this::handleMessage);&#10;        setupInternalHandlers();&#10;    }&#10;&#10;    private void setupInternalHandlers() {&#10;        // Обработка ROOM_LIST - начало сбора комнат&#10;        eventBus.subscribe(&quot;ROOM_LIST&quot;, event -&gt; {&#10;            expectedRooms = Integer.parseInt(event.getPart(1));&#10;            tempRooms.clear();&#10;&#10;            // Если комнат 0, сразу публикуем событие с пустым списком&#10;            if (expectedRooms == 0) {&#10;                eventBus.publish(new ServerEvent(&quot;ROOMS_LOADED&quot;,&#10;                        new String[]{&quot;ROOMS_LOADED&quot;}, &quot;ROOMS_LOADED&quot;));&#10;            }&#10;        });&#10;&#10;        // Обработка ROOM - добавление комнаты в список&#10;        eventBus.subscribe(&quot;ROOM&quot;, event -&gt; {&#10;            tempRooms.add(event.getFullMessage().substring(5));&#10;&#10;            // Когда собрали все комнаты, публикуем событие&#10;            if (tempRooms.size() == expectedRooms) {&#10;                // Создаем специальное событие с полным списком комнат&#10;                String roomsData = String.join(&quot;|&quot;, tempRooms);&#10;                eventBus.publish(new ServerEvent(&quot;ROOMS_LOADED&quot;,&#10;                        new String[]{&quot;ROOMS_LOADED&quot;, roomsData}, roomsData));&#10;            }&#10;        });&#10;&#10;        // Обработка ROOM_CREATED - автоматический запрос списка комнат&#10;        eventBus.subscribe(&quot;ROOM_CREATED&quot;, event -&gt; {&#10;            requestRooms();&#10;        });&#10;    }&#10;&#10;    private void handleMessage(String msg) {&#10;        System.out.println(&quot;SERVER: &quot; + msg);&#10;&#10;        String[] parts = msg.split(&quot; &quot;, 2); // Разделяем только на команду и остальное&#10;        String command = parts[0];&#10;&#10;        // Парсим для детального доступа&#10;        String[] allParts = msg.split(&quot; &quot;);&#10;&#10;        // Создаем событие и публикуем в шину&#10;        ServerEvent event = new ServerEvent(command, allParts, msg);&#10;        eventBus.publish(event);&#10;&#10;        // Сохраняем токен при WELCOME&#10;        if (&quot;WELCOME&quot;.equals(command) &amp;&amp; allParts.length &gt; 1) {&#10;            token = allParts[1];&#10;        }&#10;    }&#10;&#10;    // =================== Client Commands ===================&#10;&#10;    public void sendHello(String nickname) {&#10;        net.send(&quot;HELLO &quot; + nickname);&#10;    }&#10;&#10;    public void requestRooms() {&#10;        net.send(&quot;LIST&quot;);&#10;    }&#10;&#10;    public void createRoom(String name) {&#10;        net.send(&quot;CREATE &quot; + name);&#10;    }&#10;&#10;    public void joinRoom(String id) {&#10;        net.send(&quot;JOIN &quot; + id);&#10;    }&#10;&#10;    public void markReady() {&#10;        net.send(&quot;READY&quot;);&#10;    }&#10;&#10;    public void sendMove(String move) {&#10;        net.send(&quot;MOVE &quot; + move);&#10;    }&#10;&#10;    public void leaveRoom() {&#10;        net.send(&quot;LEAVE&quot;);&#10;    }&#10;&#10;    public void requestOpponentInfo() {&#10;        net.send(&quot;GET_OPPONENT&quot;);&#10;    }&#10;&#10;    public String getToken() {&#10;        return token;&#10;    }&#10;&#10;    public EventBus getEventBus() {&#10;        return eventBus;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/server/include/client.h">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/server/include/client.h" />
              <option name="originalContent" value="#ifndef RPS_09_CLIENT_H&#10;#define RPS_09_CLIENT_H&#10;&#10;#include &quot;server.h&quot;&#10;&#10;// Client management functions&#10;int register_client(client_t *c);&#10;void unregister_client(const client_t *c);&#10;client_t* find_client_by_fd(int fd);&#10;void gen_token(char *out);&#10;&#10;#endif //RPS_09_CLIENT_H&#10;" />
              <option name="updatedContent" value="#ifndef RPS_09_CLIENT_H&#10;#define RPS_09_CLIENT_H&#10;&#10;#include &quot;server.h&quot;&#10;&#10;// Client management functions&#10;int register_client(client_t *c);&#10;void unregister_client(const client_t *c);&#10;client_t* find_client_by_fd(int fd);&#10;void gen_token(char *out);&#10;&#10;#endif //RPS_09_CLIENT_H&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/server/include/commands.h">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/server/include/commands.h" />
              <option name="originalContent" value="#ifndef RPS_09_COMMANDS_H&#10;#define RPS_09_COMMANDS_H&#10;&#10;#include &quot;server.h&quot;&#10;#include &quot;game.h&quot;&#10;&#10;// Command handlers&#10;void handle_line(client_t *c, char *line);&#10;void handle_hello(client_t *c, char *args);&#10;void handle_list(const client_t *c);&#10;void handle_create(client_t *c, char *args);&#10;void handle_join(client_t *c, char *args);&#10;void handle_ready(client_t *c);&#10;void handle_leave(client_t *c);&#10;void handle_move(client_t *c, char *args);&#10;void handle_get_opponent(client_t *c);&#10;void handle_quit(client_t *c);&#10;&#10;#endif //RPS_09_COMMANDS_H&#10;" />
              <option name="updatedContent" value="#ifndef RPS_09_COMMANDS_H&#10;#define RPS_09_COMMANDS_H&#10;&#10;#include &quot;server.h&quot;&#10;#include &quot;game.h&quot;&#10;&#10;// Command handlers&#10;void handle_line(client_t *c, char *line);&#10;void handle_hello(client_t *c, char *args);&#10;void handle_list(const client_t *c);&#10;void handle_create(client_t *c, char *args);&#10;void handle_join(client_t *c, char *args);&#10;void handle_ready(client_t *c);&#10;void handle_leave(client_t *c);&#10;void handle_move(client_t *c, char *args);&#10;void handle_get_opponent(client_t *c);&#10;void handle_quit(client_t *c);&#10;&#10;#endif //RPS_09_COMMANDS_H" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>